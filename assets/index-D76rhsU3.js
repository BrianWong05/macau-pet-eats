import{a as F,u as A,j as e,s as v}from"./index-DjPhMvzf.js";import{r as n}from"./react-vendor-7d_4YsRm.js";import{X as w,a as D,w as H,c as O,t as L}from"./ui-vendor-uHOkKSV_.js";function G({isOpen:m,onClose:f,onSuccess:_,review:s}){const{user:N}=F(),{t:a}=A(["profile","common","restaurant","submit"]),[g,y]=n.useState(s.rating),[R,k]=n.useState(s.comment||""),[d,S]=n.useState(s.images&&s.images.length>0?s.images:s.image_url?[s.image_url]:[]),[x,p]=n.useState([]),[h,b]=n.useState([]),[j,z]=n.useState(!1),[E,u]=n.useState(null);n.useEffect(()=>{m&&(y(s.rating),k(s.comment||""),S(s.images&&s.images.length>0?s.images:s.image_url?[s.image_url]:[]),p([]),b(t=>(t.forEach(r=>URL.revokeObjectURL(r)),[])),u(null))},[s,m]),n.useEffect(()=>()=>{h.forEach(t=>URL.revokeObjectURL(t))},[h]);const $=t=>{const r=t.target.files;if(!r||r.length===0)return;const l=Array.from(r);if(l.some(o=>o.size>5*1024*1024)){L.error(a("submit:form.uploadHint")||"Max 5MB");return}p(o=>[...o,...l]);const c=l.map(o=>URL.createObjectURL(o));b(o=>[...o,...c]),t.target.value=""},P=t=>{S(r=>r.filter(l=>l!==t))},q=t=>{p(r=>r.filter((l,i)=>i!==t)),b(r=>{const l=r[t];return URL.revokeObjectURL(l),r.filter((i,c)=>c!==t)})},U=async t=>{if(t.preventDefault(),!!N){if(g===0){u(a("profile:reviews.ratingRequired"));return}z(!0),u(null);try{const r=[];for(const c of x){const o=c.name.split(".").pop(),I=`${N.id}/${Math.random().toString(36).substring(2)}_${Date.now()}.${o}`,{error:C}=await v.storage.from("review-images").upload(I,c);if(C)throw C;const{data:{publicUrl:M}}=v.storage.from("review-images").getPublicUrl(I);r.push(M)}const l=[...d,...r],{error:i}=await v.from("reviews").update({rating:g,comment:R||null,images:l,image_url:l.length>0?l[0]:null}).eq("id",s.id);if(i)throw i;L.success(a("profile:reviews.updated")),_(),f()}catch(r){console.error("Update review error:",r),u(a("common:error"))}finally{z(!1)}}};return m?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-lg shadow-xl overflow-hidden animate-in fade-in zoom-in duration-200 flex flex-col max-h-[90vh]",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-neutral-100 flex-shrink-0",children:[e.jsx("h2",{className:"text-lg font-bold text-neutral-900",children:a("profile:reviews.updateReview")}),e.jsx("button",{onClick:f,className:"p-2 hover:bg-neutral-100 rounded-full transition-colors",children:e.jsx(w,{size:20,className:"text-neutral-400"})})]}),e.jsxs("form",{onSubmit:U,className:"p-4 space-y-6 overflow-y-auto flex-1",children:[E&&e.jsxs("div",{className:"p-3 bg-red-50 text-red-600 text-sm rounded-xl flex items-center gap-2",children:[e.jsx("span",{className:"w-1.5 h-1.5 bg-red-500 rounded-full"}),E]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-neutral-700",children:a("profile:reviews.yourRating")}),e.jsx("div",{className:"flex gap-2",children:[1,2,3,4,5].map(t=>e.jsx("button",{type:"button",onClick:()=>y(t),className:"focus:outline-none transition-transform hover:scale-110",children:e.jsx(D,{size:32,className:`${t<=g?"text-amber-400 fill-amber-400":"text-neutral-200 fill-neutral-200"} transition-colors`})},t))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-neutral-700",children:a("profile:reviews.yourReview")}),e.jsx("textarea",{value:R,onChange:t=>k(t.target.value),placeholder:a("profile:reviews.commentPlaceholder"),className:"w-full px-4 py-3 rounded-xl border border-neutral-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-100 resize-none h-32 transition-all outline-none"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"text-sm font-medium text-neutral-700 block",children:[a("profile:reviews.addPhoto")," (",d.length+x.length,"/5)"]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[d.map((t,r)=>e.jsxs("div",{className:"relative aspect-square group",children:[e.jsx("img",{src:t,alt:`Review ${r+1}`,className:"w-full h-full object-cover rounded-lg border border-neutral-200"}),e.jsx("button",{type:"button",onClick:()=>P(t),className:"absolute -top-2 -right-2 p-1.5 bg-white rounded-full shadow-md text-neutral-500 hover:text-red-500 hover:bg-red-50 transition-colors border border-neutral-100 opacity-0 group-hover:opacity-100",children:e.jsx(w,{size:14})})]},`existing-${r}`)),h.map((t,r)=>e.jsxs("div",{className:"relative aspect-square group",children:[e.jsx("img",{src:t,alt:"New upload",className:"w-full h-full object-cover rounded-lg border border-neutral-200"}),e.jsx("button",{type:"button",onClick:()=>q(r),className:"absolute -top-2 -right-2 p-1.5 bg-white rounded-full shadow-md text-neutral-500 hover:text-red-500 hover:bg-red-50 transition-colors border border-neutral-100 opacity-0 group-hover:opacity-100",children:e.jsx(w,{size:14})})]},`new-${r}`)),d.length+x.length<5&&e.jsxs("label",{className:"aspect-square flex flex-col items-center justify-center gap-2 bg-neutral-50 border-2 border-dashed border-neutral-200 rounded-lg cursor-pointer hover:bg-neutral-100 hover:border-neutral-300 transition-colors",children:[e.jsx("div",{className:"p-2 bg-white rounded-full shadow-sm",children:e.jsx(H,{size:20,className:"text-neutral-400"})}),e.jsx("span",{className:"text-xs text-neutral-500 font-medium text-center px-1",children:a("profile:reviews.addPhoto")}),e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:$,className:"hidden"})]})]}),e.jsx("p",{className:"text-xs text-neutral-400",children:a("profile:reviews.photoHint")})]})]}),e.jsxs("div",{className:"p-4 border-t border-neutral-100 flex gap-3 bg-white flex-shrink-0",children:[e.jsx("button",{onClick:f,disabled:j,className:"flex-1 py-3 bg-neutral-100 text-neutral-700 font-bold rounded-xl hover:bg-neutral-200 transition-colors disabled:opacity-50",children:a("common:cancel")}),e.jsx("button",{onClick:U,disabled:j,className:"flex-1 py-3 bg-primary-500 text-white font-bold rounded-xl shadow-lg shadow-primary-500/20 hover:bg-primary-600 active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:j?e.jsxs(e.Fragment,{children:[e.jsx(O,{size:18,className:"animate-spin"}),a("common:processing")]}):a("profile:reviews.updateReview")})]})]})}):null}export{G as R};
