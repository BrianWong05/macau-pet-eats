import{u as q,j as e,a as B,s as f}from"./index-CmKh2cFY.js";import{r as c}from"./react-vendor-B-2HpIm1.js";import{b as O,E as R,$ as T,a0 as U,q as X,Y as G,Q,F as W,X as L,t as h}from"./ui-vendor-CRea9Wwv.js";import{P as Y}from"./index-j3PFD1q2.js";import"./supabase-K6a4hp2a.js";function Z({filterStatus:a,setFilterStatus:b}){const{t:l}=q(),v=["pending","approved","rejected","all"];return e.jsx("div",{className:"flex gap-2",children:v.map(x=>e.jsx("button",{onClick:()=>b(x),className:`px-4 py-2 rounded-lg font-medium transition-colors ${a===x?"bg-primary-500 text-white":"bg-neutral-100 text-neutral-600 hover:bg-neutral-200"}`,children:l(`admin.reports.status.${x}`)},x))})}function H({reports:a,isLoading:b,processingId:l,onApprove:v,onReject:x,onCheck:C,onEdit:j}){const{t:n}=q(),w=s=>{switch(s){case"approved":return e.jsx(Q,{className:"w-5 h-5 text-green-500"});case"rejected":return e.jsx(G,{className:"w-5 h-5 text-red-500"});default:return e.jsx(X,{className:"w-5 h-5 text-amber-500"})}},u=s=>({pet_policy:n("restaurant.reportModal.fields.pet_policy"),contact_info:n("restaurant.reportModal.fields.contact_info"),address:n("restaurant.reportModal.fields.address"),cuisine_type:n("restaurant.reportModal.fields.cuisine_type"),image:n("restaurant.reportModal.fields.image")||"相片",menu:n("restaurant.reportModal.fields.menu")||"菜單",other:n("restaurant.reportModal.fields.other")})[s]||s,y=s=>{const{field_name:m,suggested_value:E}=s;if(m==="image"||m==="menu"){const i=E.split(",").filter(Boolean);return e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:i.map((d,p)=>{const N=/\.(jpg|jpeg|png|gif|webp)$/i.test(d),g=/\.pdf$/i.test(d);return N?e.jsx("a",{href:d,target:"_blank",rel:"noopener noreferrer",children:e.jsx("img",{src:d,alt:"",className:"w-24 h-24 object-cover rounded-lg border border-neutral-200 hover:border-primary-400 transition-colors"})},p):g||d.startsWith("http")?e.jsxs("a",{href:d,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-1 px-3 py-2 bg-neutral-100 hover:bg-neutral-200 rounded-lg text-sm text-neutral-700 transition-colors",children:[e.jsx(R,{size:14}),g?"PDF":"Link"]},p):e.jsx("span",{className:"text-sm text-neutral-600",children:d},p)})})}return e.jsx("span",{className:"ml-2 font-medium text-primary-600",children:E})};return b?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(O,{className:"w-8 h-8 animate-spin text-primary-500"})}):a.length===0?e.jsx("div",{className:"text-center py-12 text-neutral-500",children:n("admin.reports.empty")}):e.jsx("div",{className:"space-y-4",children:a.map(s=>e.jsx("div",{className:"bg-white rounded-xl shadow-card p-6",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[w(s.status),e.jsx("span",{className:"font-semibold text-neutral-900",children:s.restaurant?.name_zh||s.restaurant?.name||"Unknown"}),e.jsx("a",{href:`/#/restaurants/${s.restaurant_id}`,target:"_blank",rel:"noopener noreferrer",className:"text-primary-500 hover:text-primary-600",children:e.jsx(R,{size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"text-neutral-500",children:[n("admin.reports.fieldLabel"),":"]}),e.jsx("span",{className:"ml-2 font-medium",children:u(s.field_name)})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-neutral-500",children:[n("admin.reports.suggestedValue"),":"]}),y(s)]})]}),s.reason&&e.jsx("p",{className:"mt-2 text-sm text-neutral-600 bg-neutral-50 p-2 rounded-lg",children:s.reason}),e.jsx("p",{className:"mt-2 text-xs text-neutral-400",children:new Date(s.created_at).toLocaleString()})]}),s.status==="pending"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>v(s),disabled:l===s.id,className:"px-4 py-2 bg-green-500 hover:bg-green-600 disabled:bg-neutral-300 text-white rounded-lg font-medium transition-colors",children:l===s.id?"...":n("admin.reports.approve")}),e.jsxs("button",{onClick:()=>j(s),disabled:l===s.id,className:"px-4 py-2 bg-amber-500 hover:bg-amber-600 disabled:bg-neutral-300 text-white rounded-lg font-medium transition-colors flex items-center gap-1",children:[e.jsx(T,{size:16}),n("admin.reports.edit")||"編輯"]}),e.jsxs("button",{onClick:()=>C(s.id),disabled:l===s.id,className:"px-4 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-neutral-300 text-white rounded-lg font-medium transition-colors flex items-center gap-1",children:[e.jsx(U,{size:16}),l===s.id?"...":n("admin.reports.check")]}),e.jsx("button",{onClick:()=>x(s.id),disabled:l===s.id,className:"px-4 py-2 bg-red-500 hover:bg-red-600 disabled:bg-neutral-300 text-white rounded-lg font-medium transition-colors",children:l===s.id?"...":n("admin.reports.reject")})]})]})},s.id))})}const J=[10,25,50,100];function re(){const{t:a}=q(),{user:b}=B(),[l,v]=c.useState([]),[x,C]=c.useState(!0),[j,n]=c.useState("pending"),[w,u]=c.useState(null),[y,s]=c.useState(1),[m,E]=c.useState(25),[i,d]=c.useState(null),[p,N]=c.useState(""),g=async()=>{C(!0);let t=f.from("restaurant_reports").select(`
        *,
        restaurant:restaurants(id, name, name_zh)
      `).order("created_at",{ascending:!1});j!=="all"&&(t=t.eq("status",j));const{data:r,error:o}=await t;!o&&r&&v(r),C(!1)};c.useEffect(()=>{g()},[j]),c.useEffect(()=>{s(1)},[j,m]);const M=Math.ceil(l.length/m),V=c.useMemo(()=>{const t=(y-1)*m;return l.slice(t,t+m)},[l,y,m]),F=t=>{d(t),N(t.suggested_value)},$=async()=>{if(i){u(i.id);try{const{error:t}=await f.from("restaurant_reports").update({suggested_value:p}).eq("id",i.id);if(t)throw t;h.success(a("admin.reports.editSuccess")||"已更新"),d(null),g()}catch(t){console.error("Edit error:",t),h.error(a("admin.reports.editError")||"更新失敗")}finally{u(null)}}},A=async t=>{u(t.id);try{if(t.field_name==="image"||t.field_name==="menu"){const o=t.field_name==="image"?"gallery_images":"menu_images",_=t.suggested_value.split(",").filter(Boolean),{data:k}=await f.from("restaurants").select(o).eq("id",t.restaurant_id).single(),S=[...k?k[o]||[]:[],..._],{error:z}=await f.from("restaurants").update({[o]:S}).eq("id",t.restaurant_id);if(z)throw z}else{const o={};if(t.field_name==="cuisine_type"){const k=t.suggested_value.includes(",")?t.suggested_value.split(",").map(P=>P.trim()):[t.suggested_value.trim()];o[t.field_name]=k}else o[t.field_name]=t.suggested_value;const{error:_}=await f.from("restaurants").update(o).eq("id",t.restaurant_id);if(_)throw _}const{error:r}=await f.from("restaurant_reports").update({status:"approved",reviewed_at:new Date().toISOString(),reviewed_by:b?.id}).eq("id",t.id);if(r)throw r;h.success(a("admin.reports.approveSuccess")),g()}catch(r){console.error("Approve error:",r),h.error(a("admin.reports.approveError"))}finally{u(null)}},D=async t=>{u(t);try{const{error:r}=await f.from("restaurant_reports").update({status:"rejected",reviewed_at:new Date().toISOString(),reviewed_by:b?.id}).eq("id",t);if(r)throw r;h.success(a("admin.reports.rejectSuccess")),g()}catch(r){console.error("Reject error:",r),h.error(a("admin.reports.rejectError"))}finally{u(null)}},I=async t=>{u(t);try{const{error:r}=await f.from("restaurant_reports").update({status:"approved",reviewed_at:new Date().toISOString(),reviewed_by:b?.id}).eq("id",t);if(r)throw r;h.success(a("admin.reports.checkSuccess")),g()}catch(r){console.error("Check error:",r),h.error(a("admin.reports.checkError"))}finally{u(null)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("h1",{className:"text-2xl font-bold text-neutral-900 flex items-center gap-3",children:[e.jsx(W,{className:"text-primary-500"}),a("admin.reports.title")]})}),e.jsx(Z,{filterStatus:j,setFilterStatus:n}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm text-neutral-500",children:a("search.results",{count:l.length})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("label",{htmlFor:"reports-page-size",className:"text-sm text-neutral-500",children:[a("search.perPage"),":"]}),e.jsx("select",{id:"reports-page-size",value:m,onChange:t=>E(Number(t.target.value)),className:"px-3 py-1.5 text-sm border border-neutral-200 rounded-lg bg-white focus:ring-2 focus:ring-primary-500",children:J.map(t=>e.jsx("option",{value:t,children:t},t))})]})]}),e.jsx(H,{reports:V,isLoading:x,processingId:w,onApprove:A,onReject:D,onCheck:I,onEdit:F}),e.jsx(Y,{currentPage:y,totalPages:M,onPageChange:s}),i&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"p-6 border-b border-neutral-100 flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold text-neutral-900",children:a("admin.reports.editTitle")||"編輯回報"}),e.jsx("button",{onClick:()=>d(null),className:"p-2 hover:bg-neutral-100 rounded-full transition-colors",children:e.jsx(L,{size:20,className:"text-neutral-500"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsx("div",{children:e.jsxs("label",{className:"block text-sm font-medium text-neutral-700 mb-1",children:[a("admin.reports.fieldLabel"),": ",i.field_name]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 mb-1",children:i.field_name==="image"||i.field_name==="menu"?a("admin.reports.images")||"圖片":a("admin.reports.suggestedValue")}),!(i.field_name==="image"||i.field_name==="menu")&&e.jsx("textarea",{value:p,onChange:t=>N(t.target.value),rows:5,className:"w-full px-4 py-2 border border-neutral-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500"}),(i.field_name==="image"||i.field_name==="menu")&&e.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:p.split(",").filter(Boolean).map((t,r)=>{const o=t.trim();return/\.(jpg|jpeg|png|gif|webp)$/i.test(o)?e.jsxs("div",{className:"relative group w-20 h-20",children:[e.jsx("img",{src:o,alt:"",className:"w-full h-full object-cover rounded-lg border border-neutral-200"}),e.jsxs("div",{className:"absolute inset-0 bg-black/50 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>window.open(o,"_blank"),className:"p-1 bg-white/20 hover:bg-white/40 text-white rounded-full transition-colors",title:a("common.view")||"查看",children:e.jsx(R,{size:14})}),e.jsx("button",{type:"button",onClick:()=>{const P=p.split(",").map(S=>S.trim()).filter(Boolean).filter(S=>S!==o);N(P.join(","))},className:"p-1 bg-red-500/80 hover:bg-red-500 text-white rounded-full transition-colors",title:a("common.delete")||"刪除",children:e.jsx(L,{size:14})})]})]},r):null})})]}),e.jsxs("div",{className:"pt-2 flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>d(null),className:"px-4 py-2 text-neutral-600 hover:bg-neutral-50 rounded-lg font-medium transition-colors",children:a("common.cancel")}),e.jsx("button",{onClick:$,disabled:w===i.id,className:"px-4 py-2 bg-primary-500 text-white rounded-lg font-medium hover:bg-primary-600 transition-colors disabled:opacity-50",children:w===i.id?"...":a("common.save")||"保存"})]})]})]})})]})}export{re as AdminReports};
