import{u as z,j as e,a as $,s as x}from"./index-da4C4Nok.js";import{r as h}from"./react-vendor-B-2HpIm1.js";import{b as D,E as q,_ as F,$ as A,q as B,W as O,O as P,F as U,X as V,t as p}from"./ui-vendor-BzBFCVgS.js";import"./supabase-K6a4hp2a.js";function I({filterStatus:a,setFilterStatus:f}){const{t:o}=z(),v=["pending","approved","rejected","all"];return e.jsx("div",{className:"flex gap-2",children:v.map(u=>e.jsx("button",{onClick:()=>f(u),className:`px-4 py-2 rounded-lg font-medium transition-colors ${a===u?"bg-primary-500 text-white":"bg-neutral-100 text-neutral-600 hover:bg-neutral-200"}`,children:o(`admin.reports.status.${u}`)},u))})}function T({reports:a,isLoading:f,processingId:o,onApprove:v,onReject:u,onCheck:S,onEdit:b}){const{t:n}=z(),w=s=>{switch(s){case"approved":return e.jsx(P,{className:"w-5 h-5 text-green-500"});case"rejected":return e.jsx(O,{className:"w-5 h-5 text-red-500"});default:return e.jsx(B,{className:"w-5 h-5 text-amber-500"})}},d=s=>({pet_policy:n("restaurant.reportModal.fields.pet_policy"),contact_info:n("restaurant.reportModal.fields.contact_info"),address:n("restaurant.reportModal.fields.address"),cuisine_type:n("restaurant.reportModal.fields.cuisine_type"),image:n("restaurant.reportModal.fields.image")||"相片",menu:n("restaurant.reportModal.fields.menu")||"菜單",other:n("restaurant.reportModal.fields.other")})[s]||s,i=s=>{const{field_name:m,suggested_value:j}=s;if(m==="image"||m==="menu"){const g=j.split(",").filter(Boolean);return e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:g.map((c,y)=>{const R=/\.(jpg|jpeg|png|gif|webp)$/i.test(c),C=/\.pdf$/i.test(c);return R?e.jsx("a",{href:c,target:"_blank",rel:"noopener noreferrer",children:e.jsx("img",{src:c,alt:"",className:"w-24 h-24 object-cover rounded-lg border border-neutral-200 hover:border-primary-400 transition-colors"})},y):C||c.startsWith("http")?e.jsxs("a",{href:c,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-1 px-3 py-2 bg-neutral-100 hover:bg-neutral-200 rounded-lg text-sm text-neutral-700 transition-colors",children:[e.jsx(q,{size:14}),C?"PDF":"Link"]},y):e.jsx("span",{className:"text-sm text-neutral-600",children:c},y)})})}return e.jsx("span",{className:"ml-2 font-medium text-primary-600",children:j})};return f?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(D,{className:"w-8 h-8 animate-spin text-primary-500"})}):a.length===0?e.jsx("div",{className:"text-center py-12 text-neutral-500",children:n("admin.reports.empty")}):e.jsx("div",{className:"space-y-4",children:a.map(s=>e.jsx("div",{className:"bg-white rounded-xl shadow-card p-6",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[w(s.status),e.jsx("span",{className:"font-semibold text-neutral-900",children:s.restaurant?.name_zh||s.restaurant?.name||"Unknown"}),e.jsx("a",{href:`/#/restaurants/${s.restaurant_id}`,target:"_blank",rel:"noopener noreferrer",className:"text-primary-500 hover:text-primary-600",children:e.jsx(q,{size:16})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"text-neutral-500",children:[n("admin.reports.fieldLabel"),":"]}),e.jsx("span",{className:"ml-2 font-medium",children:d(s.field_name)})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-neutral-500",children:[n("admin.reports.suggestedValue"),":"]}),i(s)]})]}),s.reason&&e.jsx("p",{className:"mt-2 text-sm text-neutral-600 bg-neutral-50 p-2 rounded-lg",children:s.reason}),e.jsx("p",{className:"mt-2 text-xs text-neutral-400",children:new Date(s.created_at).toLocaleString()})]}),s.status==="pending"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>v(s),disabled:o===s.id,className:"px-4 py-2 bg-green-500 hover:bg-green-600 disabled:bg-neutral-300 text-white rounded-lg font-medium transition-colors",children:o===s.id?"...":n("admin.reports.approve")}),e.jsxs("button",{onClick:()=>b(s),disabled:o===s.id,className:"px-4 py-2 bg-amber-500 hover:bg-amber-600 disabled:bg-neutral-300 text-white rounded-lg font-medium transition-colors flex items-center gap-1",children:[e.jsx(F,{size:16}),n("admin.reports.edit")||"編輯"]}),e.jsxs("button",{onClick:()=>S(s.id),disabled:o===s.id,className:"px-4 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-neutral-300 text-white rounded-lg font-medium transition-colors flex items-center gap-1",children:[e.jsx(A,{size:16}),o===s.id?"...":n("admin.reports.check")]}),e.jsx("button",{onClick:()=>u(s.id),disabled:o===s.id,className:"px-4 py-2 bg-red-500 hover:bg-red-600 disabled:bg-neutral-300 text-white rounded-lg font-medium transition-colors",children:o===s.id?"...":n("admin.reports.reject")})]})]})},s.id))})}function J(){const{t:a}=z(),{user:f}=$(),[o,v]=h.useState([]),[u,S]=h.useState(!0),[b,n]=h.useState("pending"),[w,d]=h.useState(null),[i,s]=h.useState(null),[m,j]=h.useState(""),g=async()=>{S(!0);let t=x.from("restaurant_reports").select(`
        *,
        restaurant:restaurants(id, name, name_zh)
      `).order("created_at",{ascending:!1});b!=="all"&&(t=t.eq("status",b));const{data:r,error:l}=await t;!l&&r&&v(r),S(!1)};h.useEffect(()=>{g()},[b]);const c=t=>{s(t),j(t.suggested_value)},y=async()=>{if(i){d(i.id);try{const{error:t}=await x.from("restaurant_reports").update({suggested_value:m}).eq("id",i.id);if(t)throw t;p.success(a("admin.reports.editSuccess")||"已更新"),s(null),g()}catch(t){console.error("Edit error:",t),p.error(a("admin.reports.editError")||"更新失敗")}finally{d(null)}}},R=async t=>{d(t.id);try{if(t.field_name==="image"||t.field_name==="menu"){const l=t.field_name==="image"?"gallery_images":"menu_images",_=t.suggested_value.split(",").filter(Boolean),{data:N}=await x.from("restaurants").select(l).eq("id",t.restaurant_id).single(),k=[...N?N[l]||[]:[],..._],{error:L}=await x.from("restaurants").update({[l]:k}).eq("id",t.restaurant_id);if(L)throw L}else{const l={};if(t.field_name==="cuisine_type"){const N=t.suggested_value.includes(",")?t.suggested_value.split(",").map(E=>E.trim()):[t.suggested_value.trim()];l[t.field_name]=N}else l[t.field_name]=t.suggested_value;const{error:_}=await x.from("restaurants").update(l).eq("id",t.restaurant_id);if(_)throw _}const{error:r}=await x.from("restaurant_reports").update({status:"approved",reviewed_at:new Date().toISOString(),reviewed_by:f?.id}).eq("id",t.id);if(r)throw r;p.success(a("admin.reports.approveSuccess")),g()}catch(r){console.error("Approve error:",r),p.error(a("admin.reports.approveError"))}finally{d(null)}},C=async t=>{d(t);try{const{error:r}=await x.from("restaurant_reports").update({status:"rejected",reviewed_at:new Date().toISOString(),reviewed_by:f?.id}).eq("id",t);if(r)throw r;p.success(a("admin.reports.rejectSuccess")),g()}catch(r){console.error("Reject error:",r),p.error(a("admin.reports.rejectError"))}finally{d(null)}},M=async t=>{d(t);try{const{error:r}=await x.from("restaurant_reports").update({status:"approved",reviewed_at:new Date().toISOString(),reviewed_by:f?.id}).eq("id",t);if(r)throw r;p.success(a("admin.reports.checkSuccess")),g()}catch(r){console.error("Check error:",r),p.error(a("admin.reports.checkError"))}finally{d(null)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("h1",{className:"text-2xl font-bold text-neutral-900 flex items-center gap-3",children:[e.jsx(U,{className:"text-primary-500"}),a("admin.reports.title")]})}),e.jsx(I,{filterStatus:b,setFilterStatus:n}),e.jsx(T,{reports:o,isLoading:u,processingId:w,onApprove:R,onReject:C,onCheck:M,onEdit:c}),i&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"p-6 border-b border-neutral-100 flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold text-neutral-900",children:a("admin.reports.editTitle")||"編輯回報"}),e.jsx("button",{onClick:()=>s(null),className:"p-2 hover:bg-neutral-100 rounded-full transition-colors",children:e.jsx(V,{size:20,className:"text-neutral-500"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsx("div",{children:e.jsxs("label",{className:"block text-sm font-medium text-neutral-700 mb-1",children:[a("admin.reports.fieldLabel"),": ",i.field_name]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 mb-1",children:i.field_name==="image"||i.field_name==="menu"?a("admin.reports.images")||"圖片":a("admin.reports.suggestedValue")}),!(i.field_name==="image"||i.field_name==="menu")&&e.jsx("textarea",{value:m,onChange:t=>j(t.target.value),rows:5,className:"w-full px-4 py-2 border border-neutral-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500"}),(i.field_name==="image"||i.field_name==="menu")&&e.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:m.split(",").filter(Boolean).map((t,r)=>{const l=t.trim();return/\.(jpg|jpeg|png|gif|webp)$/i.test(l)?e.jsxs("div",{className:"relative group w-20 h-20",children:[e.jsx("img",{src:l,alt:"",className:"w-full h-full object-cover rounded-lg border border-neutral-200"}),e.jsxs("div",{className:"absolute inset-0 bg-black/50 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>window.open(l,"_blank"),className:"p-1 bg-white/20 hover:bg-white/40 text-white rounded-full transition-colors",title:a("common.view")||"查看",children:e.jsx(q,{size:14})}),e.jsx("button",{type:"button",onClick:()=>{const E=m.split(",").map(k=>k.trim()).filter(Boolean).filter(k=>k!==l);j(E.join(","))},className:"p-1 bg-red-500/80 hover:bg-red-500 text-white rounded-full transition-colors",title:a("common.delete")||"刪除",children:e.jsx(V,{size:14})})]})]},r):null})})]}),e.jsxs("div",{className:"pt-2 flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>s(null),className:"px-4 py-2 text-neutral-600 hover:bg-neutral-50 rounded-lg font-medium transition-colors",children:a("common.cancel")}),e.jsx("button",{onClick:y,disabled:w===i.id,className:"px-4 py-2 bg-primary-500 text-white rounded-lg font-medium hover:bg-primary-600 transition-colors disabled:opacity-50",children:w===i.id?"...":a("common.save")||"保存"})]})]})]})})]})}export{J as AdminReports};
