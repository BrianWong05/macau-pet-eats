import{u as F,j as e,a as Y,s as b}from"./index-CdrfHzWc.js";import{r as m}from"./react-vendor-7d_4YsRm.js";import{c as ee,E as D,h as te,$ as se,_ as re,s as ae,a5 as ne,O as ie,F as le,X as V,t as y}from"./ui-vendor-uHOkKSV_.js";import{P as oe}from"./index-DUph1MOJ.js";import"./supabase-K6a4hp2a.js";function ce({filterStatus:r,setFilterStatus:w}){const{t:i}=F(["admin"]),C=["pending","approved","rejected","all"];return e.jsx("div",{className:"flex gap-2",children:C.map(j=>e.jsx("button",{onClick:()=>w(j),className:`px-4 py-2 rounded-lg font-medium transition-colors ${r===j?"bg-primary-500 text-white":"bg-neutral-100 text-neutral-600 hover:bg-neutral-200"}`,children:i(`admin:reports.status.${j}`)},j))})}function de({reports:r,isLoading:w,processingId:i,onApprove:C,onReject:j,onCheck:M,onEdit:N}){const{t:l}=F(["admin","restaurant"]),S=s=>{switch(s){case"approved":return e.jsx(ie,{className:"w-5 h-5 text-green-500"});case"rejected":return e.jsx(ne,{className:"w-5 h-5 text-red-500"});default:return e.jsx(ae,{className:"w-5 h-5 text-amber-500"})}},x=s=>({pet_policy:l("restaurant:reportModal.fields.pet_policy"),contact_info:l("restaurant:reportModal.fields.contact_info"),address:l("restaurant:reportModal.fields.address"),cuisine_type:l("restaurant:reportModal.fields.cuisine_type"),image:l("restaurant:reportModal.fields.image")||"相片",menu:l("restaurant:reportModal.fields.menu")||"菜單",other:l("restaurant:reportModal.fields.other")})[s]||s,E=s=>{const{field_name:f,suggested_value:R}=s;if(f==="image"||f==="menu"){const c=R.split(",").filter(Boolean);return e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:c.map((u,v)=>{const P=/\.(jpg|jpeg|png|gif|webp)$/i.test(u),d=/\.pdf$/i.test(u);return P?e.jsx("a",{href:u,target:"_blank",rel:"noopener noreferrer",children:e.jsx("img",{src:u,alt:"",className:"w-24 h-24 object-cover rounded-lg border border-neutral-200 hover:border-primary-400 transition-colors"})},v):d||u.startsWith("http")?e.jsxs("a",{href:u,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-1 px-3 py-2 bg-neutral-100 hover:bg-neutral-200 rounded-lg text-sm text-neutral-700 transition-colors",children:[e.jsx(D,{size:14}),d?"PDF":"Link"]},v):e.jsx("span",{className:"text-sm text-neutral-600",children:u},v)})})}return e.jsx("span",{className:"ml-2 font-medium text-primary-600",children:R})};return w?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(ee,{className:"w-8 h-8 animate-spin text-primary-500"})}):r.length===0?e.jsx("div",{className:"text-center py-12 text-neutral-500",children:l("admin:reports.empty")}):e.jsx("div",{className:"space-y-4",children:r.map(s=>e.jsx("div",{className:"bg-white rounded-xl shadow-card p-6",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[S(s.status),e.jsx("span",{className:"font-semibold text-neutral-900",children:s.restaurant?.name_zh||s.restaurant?.name||"Unknown"}),e.jsx("a",{href:`/#/restaurants/${s.restaurant_id}`,target:"_blank",rel:"noopener noreferrer",className:"text-primary-500 hover:text-primary-600",children:e.jsx(D,{size:16})})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-4 p-2 bg-neutral-50 rounded-lg w-fit",children:[e.jsx("div",{className:"w-6 h-6 rounded-full bg-neutral-200 flex items-center justify-center",children:e.jsx(te,{size:14,className:"text-neutral-500"})}),e.jsx("span",{className:"text-sm text-neutral-700 font-medium",children:s.profile?.email||"Anonymous User"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"text-neutral-500",children:[l("admin:reports.fieldLabel"),":"]}),e.jsx("span",{className:"ml-2 font-medium",children:x(s.field_name)})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-neutral-500",children:[l("admin:reports.suggestedValue"),":"]}),E(s)]})]}),s.reason&&e.jsx("p",{className:"mt-2 text-sm text-neutral-600 bg-neutral-50 p-2 rounded-lg",children:s.reason}),e.jsx("p",{className:"mt-2 text-xs text-neutral-400",children:new Date(s.created_at).toLocaleString()})]}),s.status==="pending"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>C(s),disabled:i===s.id,className:"px-4 py-2 bg-green-500 hover:bg-green-600 disabled:bg-neutral-300 text-white rounded-lg font-medium transition-colors",children:i===s.id?"...":l("admin:reports.approve")}),e.jsxs("button",{onClick:()=>N(s),disabled:i===s.id,className:"px-4 py-2 bg-amber-500 hover:bg-amber-600 disabled:bg-neutral-300 text-white rounded-lg font-medium transition-colors flex items-center gap-1",children:[e.jsx(se,{size:16}),l("admin:reports.edit")||"編輯"]}),e.jsxs("button",{onClick:()=>M(s.id),disabled:i===s.id,className:"px-4 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-neutral-300 text-white rounded-lg font-medium transition-colors flex items-center gap-1",children:[e.jsx(re,{size:16}),i===s.id?"...":l("admin:reports.check")]}),e.jsx("button",{onClick:()=>j(s.id),disabled:i===s.id,className:"px-4 py-2 bg-red-500 hover:bg-red-600 disabled:bg-neutral-300 text-white rounded-lg font-medium transition-colors",children:i===s.id?"...":l("admin:reports.reject")})]})]})},s.id))})}const me=[10,25,50,100];function be(){const{t:r}=F(["admin","search","common"]),{user:w}=Y(),[i,C]=m.useState([]),[j,M]=m.useState(!0),[N,l]=m.useState("pending"),[S,x]=m.useState(null),[E,s]=m.useState(1),[f,R]=m.useState(25),[c,u]=m.useState(null),[v,P]=m.useState(""),[d,k]=m.useState(null),[L,z]=m.useState(""),A=async()=>{M(!0);let t=b.from("restaurant_reports").select(`
        *,
        restaurant:restaurants(id, name, name_zh)
      `).order("created_at",{ascending:!1});N!=="all"&&(t=t.eq("status",N));const{data:o,error:a}=await t;if(!a&&o){const p=o,_=p.map(n=>n.user_id),h=Array.from(new Set(_.filter(n=>typeof n=="string"&&n.trim().length>0&&/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(n))));let g={};if(h.length>0)try{const{data:n,error:I}=await b.from("profiles").select("id, email").in("id",h);I&&console.error("Error fetching profiles:",I),n&&(g=n.reduce((Q,$)=>({...Q,[$.id]:$}),{}))}catch(n){console.error("Exception fetching profiles:",n)}const q=p.map(n=>({...n,profile:n.user_id?g[n.user_id]:void 0}));C(q)}M(!1)};m.useEffect(()=>{A()},[N]),m.useEffect(()=>{s(1)},[N,f]);const O=Math.ceil(i.length/f),U=m.useMemo(()=>{const t=(E-1)*f;return i.slice(t,t+f)},[i,E,f]),B=t=>{u(t),P(t.suggested_value)},T=async()=>{if(c){x(c.id);try{const{error:t}=await b.from("restaurant_reports").update({suggested_value:v}).eq("id",c.id);if(t)throw t;y.success(r("admin:reports.editSuccess")||"已更新"),u(null),A()}catch(t){console.error("Edit error:",t),y.error(r("admin:reports.editError")||"更新失敗")}finally{x(null)}}},W=async(t,o)=>{x(t.id);try{if(t.field_name==="image"||t.field_name==="menu"){const p=t.field_name==="image"?"gallery_images":"menu_images",_=t.suggested_value.split(",").filter(Boolean),{data:h}=await b.from("restaurants").select(p).eq("id",t.restaurant_id).single(),q=[...h?h[p]||[]:[],..._],{error:n}=await b.from("restaurants").update({[p]:q}).eq("id",t.restaurant_id);if(n)throw n}else{const p={};if(t.field_name==="cuisine_type"){const h=t.suggested_value.includes(",")?t.suggested_value.split(",").map(g=>g.trim()):[t.suggested_value.trim()];p[t.field_name]=h}else p[t.field_name]=t.suggested_value;const{error:_}=await b.from("restaurants").update(p).eq("id",t.restaurant_id);if(_)throw _}const{error:a}=await b.from("restaurant_reports").update({status:"approved",admin_comment:o||null,reviewed_at:new Date().toISOString(),reviewed_by:w?.id}).eq("id",t.id);if(a)throw a;y.success(r("admin:reports.approveSuccess")),A()}catch(a){console.error("Approve error:",a),y.error(r("admin:reports.approveError"))}finally{x(null)}},X=async(t,o)=>{x(t);try{const{error:a}=await b.from("restaurant_reports").update({status:"rejected",admin_comment:o||null,reviewed_at:new Date().toISOString(),reviewed_by:w?.id}).eq("id",t);if(a)throw a;y.success(r("admin:reports.rejectSuccess")),A()}catch(a){console.error("Reject error:",a),y.error(r("admin:reports.rejectError"))}finally{x(null)}},G=t=>{k({type:"approve",report:t}),z("")},Z=t=>{const o=i.find(a=>a.id===t);o&&(k({type:"reject",report:o}),z(""))},H=t=>{const o=i.find(a=>a.id===t);o&&(k({type:"check",report:o}),z(""))},J=async()=>{d&&(d.type==="approve"?await W(d.report,L||void 0):d.type==="reject"?await X(d.report.id,L||void 0):d.type==="check"&&await K(d.report.id,L||void 0),k(null),z(""))},K=async(t,o)=>{x(t);try{const{error:a}=await b.from("restaurant_reports").update({status:"approved",admin_comment:o||null,reviewed_at:new Date().toISOString(),reviewed_by:w?.id}).eq("id",t);if(a)throw a;y.success(r("admin:reports.checkSuccess")),A()}catch(a){console.error("Check error:",a),y.error(r("admin:reports.checkError"))}finally{x(null)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("h1",{className:"text-2xl font-bold text-neutral-900 flex items-center gap-3",children:[e.jsx(le,{className:"text-primary-500"}),r("admin:reports.title")]})}),e.jsx(ce,{filterStatus:N,setFilterStatus:l}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm text-neutral-500",children:r("search:results",{count:i.length})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("label",{htmlFor:"reports-page-size",className:"text-sm text-neutral-500",children:[r("search:perPage"),":"]}),e.jsx("select",{id:"reports-page-size",value:f,onChange:t=>R(Number(t.target.value)),className:"px-3 py-1.5 text-sm border border-neutral-200 rounded-lg bg-white focus:ring-2 focus:ring-primary-500",children:me.map(t=>e.jsx("option",{value:t,children:t},t))})]})]}),e.jsx(de,{reports:U,isLoading:j,processingId:S,onApprove:G,onReject:Z,onCheck:H,onEdit:B}),e.jsx(oe,{currentPage:E,totalPages:O,onPageChange:s}),c&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"p-6 border-b border-neutral-100 flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold text-neutral-900",children:r("admin:reports.editTitle")||"編輯回報"}),e.jsx("button",{onClick:()=>u(null),className:"p-2 hover:bg-neutral-100 rounded-full transition-colors",children:e.jsx(V,{size:20,className:"text-neutral-500"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsx("div",{children:e.jsxs("label",{className:"block text-sm font-medium text-neutral-700 mb-1",children:[r("admin:reports.fieldLabel"),": ",c.field_name]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 mb-1",children:c.field_name==="image"||c.field_name==="menu"?r("admin:reports.images")||"圖片":r("admin:reports.suggestedValue")}),!(c.field_name==="image"||c.field_name==="menu")&&e.jsx("textarea",{value:v,onChange:t=>P(t.target.value),rows:5,className:"w-full px-4 py-2 border border-neutral-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500"}),(c.field_name==="image"||c.field_name==="menu")&&e.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:v.split(",").filter(Boolean).map((t,o)=>{const a=t.trim();return/\.(jpg|jpeg|png|gif|webp)$/i.test(a)?e.jsxs("div",{className:"relative group w-20 h-20",children:[e.jsx("img",{src:a,alt:"",className:"w-full h-full object-cover rounded-lg border border-neutral-200"}),e.jsxs("div",{className:"absolute inset-0 bg-black/50 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>window.open(a,"_blank"),className:"p-1 bg-white/20 hover:bg-white/40 text-white rounded-full transition-colors",title:r("common:view")||"查看",children:e.jsx(D,{size:14})}),e.jsx("button",{type:"button",onClick:()=>{const h=v.split(",").map(g=>g.trim()).filter(Boolean).filter(g=>g!==a);P(h.join(","))},className:"p-1 bg-red-500/80 hover:bg-red-500 text-white rounded-full transition-colors",title:r("common:delete")||"刪除",children:e.jsx(V,{size:14})})]})]},o):null})})]}),e.jsxs("div",{className:"pt-2 flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>u(null),className:"px-4 py-2 text-neutral-600 hover:bg-neutral-50 rounded-lg font-medium transition-colors",children:r("common:cancel")}),e.jsx("button",{onClick:T,disabled:S===c.id,className:"px-4 py-2 bg-primary-500 text-white rounded-lg font-medium hover:bg-primary-600 transition-colors disabled:opacity-50",children:S===c.id?"...":r("common:save")||"保存"})]})]})]})}),d&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl max-w-md w-full",children:[e.jsxs("div",{className:"p-5 border-b border-neutral-100 flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-900",children:r("admin:comment.title")||"Add Comment"}),e.jsx("button",{onClick:()=>k(null),className:"p-2 hover:bg-neutral-100 rounded-full transition-colors",children:e.jsx(V,{size:18,className:"text-neutral-500"})})]}),e.jsxs("div",{className:"p-5 space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-neutral-600 mb-2",children:r("admin:comment.hint")||"Add a comment for the user (optional)"}),e.jsx("textarea",{value:L,onChange:t=>z(t.target.value),placeholder:r("admin:comment.placeholder")||"Enter your response...",rows:3,className:"w-full px-4 py-3 border border-neutral-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 resize-none",autoFocus:!0})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>k(null),className:"flex-1 px-4 py-2 border border-neutral-200 rounded-xl font-medium text-neutral-600 hover:bg-neutral-50 transition-colors",children:r("common:cancel")}),e.jsx("button",{onClick:J,className:"flex-1 px-4 py-2 bg-primary-500 text-white rounded-xl font-medium hover:bg-primary-600 transition-colors",children:d.type==="approve"?r("admin:reports.approve"):d.type==="check"?r("admin:reports.check"):r("admin:reports.reject")})]})]})]})})]})}export{be as AdminReports};
